specVersion: 1.2.0
schema:
  file: ./schema.graphql

indexerHints:
  prune: {{prune}}

dataSources:
{{#each pools}}
  - name: ClipperDirectExchange_{{address}}
    kind: ethereum/contract
    network: {{../networkName}}
    source:
      address: '{{address}}'
      abi: ClipperDirectExchange
      startBlock: {{startBlock}}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Pool
        - PoolPair
        - PoolTransactionSource
        - Deposit
        - Withdrawal
        - Token
        - PoolToken
        - Swap
        - Pair
        - PoolPair
        - TransactionSource
        - User
        - PoolEvent
      abis:
        - name: ClipperDirectExchange
          file: ./abis/ClipperDirectExchange.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
      eventHandlers:
        - event: Deposited(indexed address,uint256,uint256)
          handler: handleDeposited
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Withdrawn(indexed address,uint256,uint256)
          handler: handleWithdrawn
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: AssetWithdrawn(indexed address,uint256,indexed address,uint256)
          handler: handleSingleAssetWithdrawn
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Swapped(indexed address,indexed address,indexed address,uint256,uint256,bytes)
          handler: handleSwapped
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Transfer(indexed address,indexed address,uint256)
          handler: handleTransfer
          {{#ifAddress permitRouter}}
          topic1: ['{{permitRouter}}']
          {{/ifAddress}}
      file: ./src/mapping.ts
{{/each}}
{{#each coves}}
  - name: ClipperCove_{{address}}
    kind: ethereum/contract
    network: {{../networkName}}
    source:
      address: '{{address}}'
      abi: ClipperCove
      startBlock: {{startBlock}}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Swap
        - Token
        - CoveTransactionSource
        - TransactionSource
        - CoveDeposit
        - CoveWithdrawal
        - Cove
        - CoveEvent
        - CoveParent
        - UserCoveStake
        - User
        - Pool
      abis:
        - name: ClipperCove
          file: ./abis/ClipperCove.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
        - name: ClipperDirectExchange
          file: ./abis/ClipperDirectExchange.json
      eventHandlers:
        - event: CoveSwapped(indexed address,indexed address,indexed address,uint256,uint256,bytes32)
          handler: handleCoveSwapped
          calls:
            ClipperCove.inAssetLastBalances: ClipperCove[event.address].lastBalances(event.params.inAsset)
            ClipperCove.outAssetLastBalances: ClipperCove[event.address].lastBalances(event.params.outAsset)
        - event: CoveDeposited(indexed address,indexed address,uint256,uint256)
          handler: handleCoveDeposited
          calls:
            ClipperCove.lastBalances: ClipperCove[event.address].lastBalances(event.params.tokenAddress)
        - event: CoveWithdrawn(indexed address,indexed address,uint256,uint256)
          handler: handleCoveWithdrawn
          calls:
            ClipperCove.lastBalances: ClipperCove[event.address].lastBalances(event.params.tokenAddress)
      file: ./src/coveMapping.ts
{{/each}}
{{#each priceOracles}}
  - name: PriceOracle_{{address}}
    kind: ethereum/contract
    network: {{../networkName}}
    source:
      address: '{{address}}'
      abi: AggregatorV3Interface
      startBlock: {{indexingStartBlock}}
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Token
        - Pool
        - PoolToken
        - PoolEvent
      abis:
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
      eventHandlers:
        - event: AnswerUpdated(indexed int256,indexed uint256,uint256)
          handler: handlePriceUpdated
      file: ./src/oracleMapping.ts
{{/each}}

templates:
  - name: ClipperDirectExchange
    kind: ethereum/contract
    network: {{networkName}}
    source:
      abi: ClipperDirectExchange
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Pool
        - PoolPair
        - PoolEvent
        - PoolTransactionSource
        - Deposit
        - Withdrawal
        - Token
        - Swap
        - Pair
        - PoolPair
        - TransactionSource
        - User
        - PoolEvent
      abis:
        - name: ClipperDirectExchange
          file: ./abis/ClipperDirectExchange.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
      eventHandlers:
        - event: Deposited(indexed address,uint256,uint256)
          handler: handleDeposited
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Withdrawn(indexed address,uint256,uint256)
          handler: handleWithdrawn
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: AssetWithdrawn(indexed address,uint256,indexed address,uint256)
          handler: handleSingleAssetWithdrawn
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Swapped(indexed address,indexed address,indexed address,uint256,uint256,bytes)
          handler: handleSwapped
          calls:
            ClipperDirectExchange.allTokensBalance: ClipperDirectExchange[event.address].allTokensBalance()
        - event: Transfer(indexed address,indexed address,uint256)
          handler: handleTransfer
          {{#ifAddress permitRouter}}
          topic1: ['{{permitRouter}}']
          {{/ifAddress}}
      file: ./src/mapping.ts
  - name: ClipperCove
    kind: ethereum/contract
    network: {{networkName}}
    source:
      abi: ClipperCove
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Swap
        - Token
        - CoveTransactionSource
        - TransactionSource
        - CoveDeposit
        - CoveWithdrawal
        - Cove
        - CoveEvent
        - CoveParent
        - UserCoveStake
        - User
        - Pool
      abis:
        - name: ClipperCove
          file: ./abis/ClipperCove.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
        - name: ClipperDirectExchange
          file: ./abis/ClipperDirectExchange.json
      eventHandlers:
        - event: CoveSwapped(indexed address,indexed address,indexed address,uint256,uint256,bytes32)
          handler: handleCoveSwapped
          calls:
            ClipperCove.inAssetLastBalances: ClipperCove[event.address].lastBalances(event.params.inAsset)
            ClipperCove.outAssetLastBalances: ClipperCove[event.address].lastBalances(event.params.outAsset)
        - event: CoveDeposited(indexed address,indexed address,uint256,uint256)
          handler: handleCoveDeposited
          calls:
            ClipperCove.lastBalances: ClipperCove[event.address].lastBalances(event.params.tokenAddress)
        - event: CoveWithdrawn(indexed address,indexed address,uint256,uint256)
          handler: handleCoveWithdrawn
          calls:
            ClipperCove.lastBalances: ClipperCove[event.address].lastBalances(event.params.tokenAddress)
      file: ./src/coveMapping.ts
  - name: PriceOracle
    kind: ethereum/contract
    network: {{networkName}}
    source:
      abi: AggregatorV3Interface
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      entities:
        - Token
        - Pool
        - PoolToken
        - PoolEvent
      abis:
        - name: AggregatorV3Interface
          file: ./abis/AggregatorV3Interface.json
      eventHandlers:
        - event: AnswerUpdated(indexed int256,indexed uint256,uint256)
          handler: handlePriceUpdated
      file: ./src/oracleMapping.ts